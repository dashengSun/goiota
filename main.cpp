#include <WINSOCK2.H>
#include <stdio.h>
#pragma comment(lib,"ws2_32.lib")
int main(int argc,char **argv)
{
    int err;
    WORD versionRequired;
    WSADATA wsaData;
    versionRequired=MAKEWORD(1,1);
    err=WSAStartup(versionRequired,&wsaData);//协议库的版本信息
    if (!err)    {
        printf("客户端嵌套字已经打开!\n");
    }else{
        printf("ERROR:客户端的嵌套字打开失败!\n");
        return 1;//结束
    }
    SOCKET clientSocket=socket(AF_INET,SOCK_STREAM,0);
	SOCKADDR_IN clientsock_in;
	if (argc == 2)
	{
		clientsock_in.sin_addr.S_un.S_addr=inet_addr(argv[1]);
	}
	else
	{
		printf("命令格式：curl_proxy_tst 127.0.0.1\n");
		return 1;
	}

    clientsock_in.sin_family=AF_INET;
	clientsock_in.sin_port = htons(33333);

    connect(clientSocket,(SOCKADDR*)&clientsock_in,sizeof(SOCKADDR));//开始连接
	int head[4] = { 999999, 123456, 2673, 1 };
//	char TX[2674] = "999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999ZDWNRTMICEUJKUZIZGXKNUXGTFQTGNXHYHYYQYLWPPWKRWFVTIOBFGMVLKGCOGHF9LINGNLPHQBO9UHSE999999999999999999999999999999999999999999999999999999CAAUHVD99999999999999999999HRNCLJOVIU999QYHADTTFLUMTDSUAYKUUBWCWACGEPWZQUHQDWSGMFFKNHAIUUVQHPXOTHFFGLUUMYRMK999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999JMM9LIDDJ9JLMMXRIGSIFMPGDICB9DWQOASRA9RWZBYEGBFXYGAWKFQNMUADWPJBTQPKDZEJDMGEPSXHU";
//	char TX[2674] = "999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999ZDWNRTMICEUJKUZIZGXKNUXGTFQTGNXHYHYYQYLWPPWKRWFVTIOBFGMVLKGCOGHF9LINGNLPHQBO9UHSE999999999999999999999999999999999999999999999999999999CAAUHVD99999999999999999999HRNCLJOVIU999QYHADTTFLUMTDSUAYKUUBWCWACGEPWZQUHQDWSGMFFKNHAIUUVQHPXOTHFFGLUUMYRMK999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999";
//	char TX[2674] = "SNKACMKUWKP9DIHWMYLJOCXEVCLWBIEWLL9DRTMSNYVLYZKZCQ9XKHOHYBZZRVNDABDJXGGLJOF9VQSLWMBVGIWBFYOKYMNBBVGMKIDUDEKGYMLYSYPBVEVGXWYHQOOZXWGNSFCXODPZKGHOBWKIWLLKUH9DCEKLSNYIIPGTUSNGSBVAYMJDTPDBCSKIRTAXUSAJINJ9AVQ9UNRSESKHWMWQYZHSPOCGTIHETSYJVCHNCAGYZODBTZNYQ9U9TTLA9KAYGUUOYBTMAFBJQBRFNYQBTNJQTUBYSCJACRMBCRTQYHUJIZYRAFGWYUMNQIFEZ9QHTOUJGPVGRYYCZCMUKJOAOYQEGCVYNFHOAMVSPXRTEKVAMGKAOLRQMBFCZGVNKKEPKXWKMVAJZYEODZRTXZQEZWEPBCLHNQWQFLT9YVPXLWGLDIDVPRLUCZVIXATDDGKBFSJTJVZOMWVJLZCV9I9YWFC9KODCG9S9QOZJXUEJEZPGZFESBZN9OGSWBKERRRPTQRKJBOGFOUSYEJWCD9KEBKYPQPTFSUHLJGBMXXMSQCZYDKDJKXZSULZRWVPC9BNWHKMZZFQBVLTESVBGQWFV9PCKTJBIPRXPJGQNCZABNWFDESMNTDHXJGYNZHZYDNAOTDLXGUXNNYJJ9CLLAJDJOITSHKHHRHVIXFSAJIEUIZKQPTVWXUDFNHARVEZBMTWAEBQJCVVKZGHJAJ9GOHRIEAFWLAOEJWRBOEPHLSTGWVIKRIOHUEYTUARNO9IYERYIDKDRTWQZTYYWDE9FQ9ZSEMZCC9BJQXCMRHYIJPARPYYEDIRMZYTPTJOQKXQXOKPJMOBAAXBHFBJSYEFJJET9QKLBMXWWNKJPP9CDRLHPCUHPQQZCEWQCJQP9B9AQPDDPZVYEJXQUCFCJIIXMIBFTWRSRKGEQOEWEZGKRMFKHDJGDKHCKF9XSCPOCBHPJUUNCNSDVOJRREABZDTDYIPWZEJKBUIYMBBKSTITAKZANRUGVJOBOEYNKVVDHOCIMYLLIRIFLMRLZOKOUHHRIDXKGZZBEUGXCJBSQYBJKCG9SMJHVQUFGLABPVQGTGJRVGWPDZHGGGBJIFXJZINKZIVOXJSTUWWJIZOVAIJBMZBWEANTWIRTFNBO9PSXXQPNVRLBJOLYWCMLJOXALULGVQVZWASMHIMQUDJC9WJQNMYHIHZGQQJLFKLDXB9KSYJECLVEAOBJEJC99ZNAYGGONNISTHYRSC9EJLEB9TWPZWKJBVIDYVXRQDKRCAGVAWYNUACZOPRUSJJBWEFFUR9PJEWLARAXDGNRYZIOYWMVRICAZMSYNGYAKITXCPAYVCGFJJBSYMCWKSKXDKMGXVHHVZYEJLNHEDTDNKHTDH9KMYWRMSURSDCBSDPWCZ9TKHIFHPKRTXWARNWPSIAFEVYH99BTEVWWXTGMNEQZJY9UQSOVDMEXCDQAANLZQVLOMJJANYEYUDJO9QAG9MFGBSZOUDHVJV9VRPQHWZFGGSWDQSHDSYFQJMNKWZUUQDPSSTDV9IZLUBVFODLXAJYDBOETZVLXCKWJTYXRMRNYXSHGQZJMZHFHKIMSOFMCAZMNRIWOEWAFNYMBONQOTRRUZGNLWOPTAMHWRTQZJGADOAVYRCGKAWYKUMBSNTCPVVSIGQZITYJIWJPVQWTKZGILS9CPDTHHQPKITPQLFYFFQCKPEFNSZACDGKUFEVYRGTMOOKQKILYIMWQTYZBCSWIBBICQSVANIYXZSRGFTUHXLGLHYDIT9ZOYKSKRVC9DIPNROGXAYUYWRU9SQCLNVBVPZEVKUCFJCM9MZKIQ99ERWKUM9SJOFVGJ9QXOV9EQMWLZNXKHKVQY9RQLQSTJCDPQQVLOZB9VBXXVHJNTPK9FORH9WXRJHWOJEIILRRGHUPPINAXADCJANNYNJAYTQHUBEAYGLHP9CIM9RXRPPYGVDGRIMMZ9SSGBRYZQOMIMYLVAYUUQUH9UGSUVYFFMXCQXAMWHPJGVXAYZBLYUXMQLLBENWZVJBIDPRQSTFFJKFPLGSBZONPBGMGI9LJHENPXEWYKYSEYBLDCTIYLKZYRNTT9ANYCAHA9D9FFAZSRQPDHTOFDGPAIOHTISXSODNTTTHFLJRYFXBYBHHOPPWINDKGTVM9SGWOWQVNHEWKMYGSBFDBCIZRPRIUJYKPBFKPWCHICGJZXKE9GSUDXZYUAPLHAKAHYHDXNPHENTERYMMBQOPSQIDENXKLKCEYCPVTZQLEEJVYJZV9BWU999999999999999999999999999QJGH99999999999999999999999LJFYTXD99999999999A99999999PXT9TE9UDVUEXMEJNBOXNYFDTCWIEOJOWFZPHXXKBYFYW9PXL9UHJBOXLTRO9HEJKNDVEGE9XDKZOXIMWZGMIEZTCUKUAF9DWLDXXJFQSE9SZAEZSOOYCXCQJFCOXOAEUKFMTRHJLSKBJVHYXLUPBJPILMIQO99999QWUXJR9LIJUWLFSYCRDEGDGTSICOBMFZYWSSGXNIUFANCQOHQU9UGJWUCVKXPWTLMSZIKSMUHQXZ99999HYDTCMFKZZYTALFOFZLHDWBFLMDYRFQCLQTQPNXPCVYAUAWYHMZTSENWOWYREHGCPSNXSQLCYHOOYGYW9";
	char TX[2674] = "UUKCVKWKRKYMQ9NEEJKCQXBHMGJDZLNKECZYWPEKBXLKXNVBLPKNLFQGVQUHLMUACYFGAOYIZCQRAKBNSLXLASMJQQT9UPSM9BRTKJHLALUFIIYZWIJ9PQ9JNCSTSXJK9NVRQTZXKQDWFUMNVVNXBJVMZPNAKZCROWTBDIVDEWVPHPBSKCFWMPWQHSTTAYHJRZJWVJBXQYUFGJKIOAEVKJ9POTIDBZADHYKLKLHPHUOOLJIHLGNGFSGCOEBXPWVTOPJLGHTXVUFOXDIIFMEVUKHHOVSYWITYDTCZQKCJHCTASAAUPIOJW9NCGIAWRYTDJHYYGBMPIJUFELYDYMDBOEYSWNNDBYGFNERZ9MAGPHRCQFKZISZXGCNYBRORMSRHKGVSHPUSWZHXXHPGIW9OBLSQQKYDVNFEGHAN9APEZ9XRLJFJ9UA9WICKKDFFAJJZBCZWUOFVTHSOJDMULYXKLCSNVUCIRPN9SKMWWDDIXCRSJJLGJKISGYWBGELBZMUSFPJDQTKZUEYCNCJMGBJGPAALZJEYGXNJTOFRNADC9W9QXRKXLGWJGWGLMLTDLWOSQ9GSHIEXPBOKAILOGLCYLAENZHBNRRBGMSNQBRKLMICXAZDFC9GIX9PHVFJSYVNABXJGHEHGAXMMSCAYHMCDT9MAQTBYZTYPGVRGVGXAAYETUPEYGXGFBTBJSXDMMKVZOVDJNWFJBHMEKKDTBDGNSOHYAXOUYUFTGNJPJJZGKV9GZINMHYSTNYSASPUSPNIFNBGXIOYGMGMUCMIQSVYNMFBGFCJQIDNNLRWIYTXWODAK9JOEDLDOMEPXBEPJDKQRXCJLHWGMYK9EUTAGSJRUGDGLQIMKIGWIUCCSSOSVQGRTBKHKAXHFTFAFIBXTIUCFAYVGZPROY9X9MEHUEGWIIFUIKMTVWYSQG9AXIQSUNIXOKMF9KQTRUDRLJFBMDHVCLVWHDNVVYYZAVOXL9USIAUKLGRCITSKLMDGWZDFPOORGOSBQYSJUJQPQXCBHAGVAINJPJJNPWUQ9MRUALINKQPAREOMYUTFNEFNMJFWXVXPDQR9MXYAMMYBAJPAVAQBVSIJVVHRKE9TOXCFZWGC9L9DSTVAUI9DPBBPZZLIZGKYRQYKIUJBRDLONQSGJSSEOAOORBWCHULSFZTPNTDRIRE9XCKIUUFTQCHCTXVBPEJM9CRSCHGBIADZTHSYHOXHQGCHWINTXJWGYJKYVRYKRLGCZOSHDKVQIPSVSPYXGSVZM9BYYUWICCOSHGEZKMZMY9KJBYITXAIJLBTZKO9WISF9WKLTGFGVKADHQJMRJWHTHIMEBGFJVGZWCGZ9GAM9FEAKKRD9FCO9VGPNTVKG9GDRL9GVTBVRYVBSPHVVZEBBABVGJOAMQWLEFU9FVZICMDVICZMDQMSWFUWEBEUTFNTBKVSYMXTHCNV9QVCRKRGPJWFSRWJBUOIISBZS9VBJLZSQJLFGOVJAOKDAZXAABQIJSUHCNNGBTPWFKDMYRGITXQGYUMS9BMBAOVRJFPCBZQZKOMFYKBOXLWXRUNFPMANE9ASCZOPIFZWOBOMJBMTANCGZHEYBLHEATJRPYWITUWYDEY9YEOVEYKDFH9CUZLDFJBQXUCORITIBCADIEBRUMMCVGSXJQBCCUAPJGZTRGUUAQBBYYUUEWVMYPDIWWP9QO9H99UWXE9ZM9IIDWQHOWNGKYXBUJRKOMMEOHWRGLWNDFMHLZGSGHUNVLRUHL9BTYHSMRYO9ICOETPDFKCRPFFKTCQIYJLXLHPJJEUZOCTOVAKFTPPZZPADTYZFUIOPNNAZOQRJZCGANHSXRSI9ZEEKKSKNNSHBGQS9ORU9IYXFTRMNXRFAFYRZYZAALADFTXTGGSWUXSSYMZIBEAFQBYKPRTULKCMS9XVGVYUHQSHADONFAWGCPQUJGD9KAJXXFQZVJDBTYLBNDFTGDMRZBAVXUYIWNTBRMCGKCMXLRMKIRKHBWTSC9EGXXWHBV9BVQBBSSYZXBPABURRLR9TBLJZWQZPWAEJMNOUPQPMQTNYERVAATLMUVTMRDJJXTZCQHFIOSDEUSNDDZUUJOFRDDKEOKAMHQUPRHHDG9UZETMVAVEKUYRPDIYGBSCNQLJJKETI9DOTXZNPZMMYRHFPJASHLZJFAMPNAOB9JNGXV9UHPSNIREHBZJKPWCHICGJZXKE9GSUDXZYUAPLHAKAHYHDXNPHENTERYMMBQOPSQIDENXKLKCEYCPVTZQLEEJVYJZV9BWU999999999999999999999999999JIGH999999999999999999999999WFYTXD99999999999A99999999QLYTJYCRECGXCUHKSSKT9MDYUTRJUSWCNUEEJM9P9RXVU9WRVZKMSUPFNBORH9GYLY9TRRCO9ADVHPKTAFGOYISSUJBIZH9DPEGMHGLFQDVHYFUTPUNN9QPKUEOCGLWAFCQIHYHVOCUGJNKKRBFTFDSJDSIKH99999AYCVBYZJJRCUNCOLXMSIWVTCYZOUHGMHVYULMYXNCMLMTB9QQDCLJXHMBKUHRIMB9QQFQQSSCEYW99999JPQXAEBVIDDAAAWEJ9JGJGSPOGFQGPIPQLJBPKWF9XUHOVZGQRDSVAQDNZC9QZBDBMYDATGYHNJFOHXJC";
//	char TX[2674] = "ISPAMISPAMISPAM999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999ITAG99999999999999999999999QEXATXD99999999999999999999PVVTVJLWKKDQFFZZJRZJODJGIMXAYGQQJAYCCBK9IGSKZHABNUKDTQWRZNRCLGBPQARNAOXKEKFDGXLNWDNB9OXZLKHDIXQE9SLJRWXEQLMZEOEENJVEROOSPULDVB9QTDJCUJLBQFQKVTDKDWEMPMYTAYYUA99999WDPBSAXVOUCAENB9JAJCWR9QZWGNSEJGUCHJRVYQMUJHZVDAISYGDQEECNMHLZVUHIO9H9VKMVRN99999WNXULNEXBYXOCPMXMCHIQNOQICXJSO9KJOC9GMWBRPCBDDVDVUDPWLFTTYVZVWADBXIJUZJ9QUKCHKPBH";
	int head_recv[4];
	char TX_recv[2674] = { 0 };
	int cnt = 0;
	int cnt_error = 0;
	if(true){
        
		for (int i = 0;i < 1000; i++)
		{
			cnt++;
			head[3] = cnt;
			send(clientSocket, (char *)head, 4 * sizeof(int), 0);

			int len = send(clientSocket, TX, 2673, 0);
			memset(head_recv, 0, sizeof(int) * 4);
			memset(TX_recv, 0, sizeof(TX_recv));
			int recv_len = 0;
			do {
				recv_len += recv(clientSocket, (char*)head_recv, sizeof(int) * 4, 0);
			} while (recv_len < 16);

			if (head_recv[0] == 999999)
			{
				recv_len = 0;
				do {
					recv_len += recv(clientSocket, (char*)TX_recv, head_recv[2], 0);
				} while (recv_len < head_recv[2]);
				printf("TX Received: ID=%d, TX=%s\n", head_recv[3], TX_recv);
				//printf("TX Received: recvID=%d, TXcnt=%d \n", head_recv[3], cnt);
			}
			else
			{
				cnt_error++;
				printf("Invalid TX received!\n");
			}
		}

        closesocket(clientSocket);
        WSACleanup();
		printf("Error packet number: %d \n", cnt_error);
    }
    return 0;
}